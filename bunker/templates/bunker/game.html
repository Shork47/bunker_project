{% extends 'bunker/base.html' %}
{% load static %}
{% load my_filters %}

{% block title %}–ö–æ–º–Ω–∞—Ç–∞ {{ room.name }} ‚Äî –ò–≥—Ä–∞ –ë—É–Ω–∫–µ—Ä{% endblock %}

{% block content %}
<div class="container-fluid mt-3 mb-0">
  <div class="row g-3">

    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="col-12 col-md-6">
      <div class="p-3 pb-0 text-white text-center">
        <h5>
          üåã 
          <span 
            data-bs-toggle="tooltip" 
            data-bs-placement="top" 
            title="{{ room.catastrophe.description }}"
            style="cursor: help;"
          >
            {{ room.catastrophe.name }}
          </span> - {{ room.year }} –ª–µ—Ç
        </h5>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="col-12 col-md-6">
      <div class="p-3 pb-0 text-white">
        <h5 class="mb-2 text-center">üèö –ö–∞—Ä—Ç—ã –±—É–Ω–∫–µ—Ä–∞</h5>
        <p id="bunkerCardsContainer" class="text-center" style="font-size: 12px;">
          {% for room_card in room.bunkerroombunker_set.all %}
            <span 
              class="bunker-card{% if room_card.is_crossed %} crossed{% endif %}"
              data-card-id="{{ room_card.id }}"
              data-bs-toggle="tooltip" 
              data-bs-placement="top" 
              title="{{ room_card.bunker.description }}"
              style="cursor: help;">
              {{ room_card.bunker.name }}
            </span>{% if not forloop.last %}, {% endif %}
          {% empty %}
            –ù–µ—Ç –∫–∞—Ä—Ç
          {% endfor %}
        </p>
      </div>
    </div>

  </div>
</div>

<div class="container-fluid px-3 py-3 pt-0 create_page" style="margin-top:0;">
  <div class="row" style="margin-top:0;">
    {% for player in players %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-3">
      <div class="card shadow-sm h-100">
        <div class="card-header text-white">
          <h5 class="mb-0">{{ player.user.username }}</h5>
        </div>
        <div class="card-body">
          <p>üíó<strong> –ó–¥–æ—Ä–æ–≤—å–µ:</strong> 
            <span 
              data-user="{{ player.user.id }}"
              data-field="health"
              data-realvalue="{{ player.health.name }}"
            >
            {% if "health" in player.opened_fields %}
              {{ player.health.name }}
            {% endif %} </span>
          </p>
          <p>üë´<strong> –ë–∏–æ–ª–æ–≥–∏—è:</strong>
            <span 
            data-user="{{ player.user.id }}"
            data-field="biology"
            data-realvalue="
            {{ player.biology.gender }} 
            {% if player.biology.age %}
              {{ player.biology.age }} {{ player.biology.age|age_filter }}
            {% endif %}
            {% if player.biology.orientation or player.biology.childbearing %}
              (
              {% if player.biology.orientation %}{{ player.biology.orientation }}{% endif %}
              {% if player.biology.orientation and player.biology.childbearing %}, {% endif %}
              {% if player.biology.childbearing %}{{ player.biology.childbearing }}{% endif %}
              )
            {% endif %}"
            >
            {% if 'biology' in player.opened_fields %}
              {{ player.biology.gender }} 
              {% if player.biology.age %}
                {{ player.biology.age }} {{ player.biology.age|age_filter }}
              {% endif %}
              {% if player.biology.orientation or player.biology.childbearing %}
                ({% if player.biology.orientation %}{{ player.biology.orientation }}{% endif %}{% if player.biology.orientation and player.biology.childbearing %}, {% endif %}{% if player.biology.childbearing %}{{ player.biology.childbearing }}{% endif %})
              {% endif %}
            {% endif %} </span>
          </p>
          <p>üé®<strong> –•–æ–±–±–∏:</strong>
            <span 
            data-user="{{ player.user.id }}"
            data-field="hobby"
            data-realvalue="{{ player.hobby.name }}"
            >
            {% if "hobby" in player.opened_fields %}
              {{ player.hobby.name }}
            {% endif %} </span>
          </p>
          <p>üò®<strong> –§–æ–±–∏—è:</strong>
            <span 
            data-user="{{ player.user.id }}"
            data-field="phobias"
            data-realvalue="{{ player.phobias.name }}"
           >
            {% if "phobias" in player.opened_fields %}
              {{ player.phobias.name }}
            {% endif %} </span>
          </p>
          <p>üë©‚Äç‚öïÔ∏è<strong> –ü—Ä–æ—Ñ–µ—Å—Å–∏—è:</strong>
            <span 
              data-user="{{ player.user.id }}"
              data-field="profession"
              data-realvalue="{{ player.profession.name }}"
            >
            {% if "profession" in player.opened_fields %}
              {{ player.profession.name }}
            {% endif %} </span>
          </p>
          
          <p>üí°<strong> –§–∞–∫—Ç 1:</strong>
            <span 
              data-user="{{ player.user.id }}"
              data-field="fact1"
              data-realvalue="{{ player.fact1.name }}"
            >
            {% if "fact1" in player.opened_fields %}
              {{ player.fact1.name }}
            {% endif %}
            </span>
          </p>
          
          <p>üí°<strong> –§–∞–∫—Ç 2:</strong>
            <span 
              data-user="{{ player.user.id }}"
              data-field="fact2"
              data-realvalue="{{ player.fact2.name }}"
            >
            {% if "fact2" in player.opened_fields %}
              {{ player.fact2.name }}
            {% endif %}
            </span>
          </p>
          
          <p>üß≥<strong> –ë–∞–≥–∞–∂:</strong>
            <span 
              data-user="{{ player.user.id }}"
              data-field="baggage"
              data-realvalue="{{ player.baggage.name }}"
            >
            {% if "baggage" in player.opened_fields %}
              {{ player.baggage.name }}
            {% endif %} </span>
          </p>
          <!-- <p>üë©‚Äç‚öïÔ∏è<strong> –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏:</strong>
            <span 
            data-user="{{ player.user.id }}"
            data-field="profession"
            data-realvalue="{% for prof in player.profession.all %}{{ prof.name }}{% if not forloop.last %}, {% endif %}{% endfor %}"
            >
            {% if "profession" in player.opened_fields %}
              {% for prof in player.profession.all %}
                {{ prof.name }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            {% endif %} </span>
          </p>

          <p>üí°<strong> –§–∞–∫—Ç—ã:</strong>
            <span 
            data-user="{{ player.user.id }}"
            data-field="fact"
            data-realvalue="{% for fact in player.fact.all %}{{ fact.name }}{% if not forloop.last %}, {% endif %}{% endfor %}"
            >
            {% if "fact" in player.opened_fields %}
              {% for fact in player.fact.all %}
                {{ fact.name }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            {% endif %} </span>
          </p>

          <p>üß≥<strong> –ë–∞–≥–∞–∂:</strong>
            <span 
            data-user="{{ player.user.id }}"
            data-field="baggage"
            data-realvalue="{% for bag in player.baggage.all %}{{ bag.name }}{% if not forloop.last %}, {% endif %}{% endfor %}"
            >
            {% if "baggage" in player.opened_fields %}
              {% for bag in player.baggage.all %}
                {{ bag.name }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            {% endif %} </span>
          </p> -->

          <!-- <p>‚ö†Ô∏è<strong> –û—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è:</strong>
            {% for sc in player.special_condition.all %}
              {{ sc.name }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </p> -->
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è -->
<button id="openSidebar" class="btn btn-light position-fixed" style="top: 90px; left: 15px; z-index: 1100;">
  –ú–æ–∏ –∫–∞—Ä—Ç–æ—á–∫–∏
</button>

<!-- –õ–µ–≤—ã–π —Å–∞–π–¥–±–∞—Ä -->
<div id="sidebar" class="sidebar">
  <div class="sidebar-header">
    <h4>–í–∞—à–∏ –∫–∞—Ä—Ç–æ—á–∫–∏</h4>
    <button id="closeSidebar" class="btn-close"></button>
  </div>

  <div class="sidebar-body">
    <!-- –ó–¥–µ—Å—å –≤—ã–≤–æ–¥–∏ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞ -->
    <p>üíó<strong> –ó–¥–æ—Ä–æ–≤—å–µ:</strong>
    <span 
      id="sidebar-health"
      data-sidebar="true"
      data-user="{{ me.user.id }}"
      data-field="health"
    >
    {{ me.health.name }}
    {% if "health" not in me.opened_fields %}
      <button class="btn btn-sm btn-primary open-field" data-field="health">–û—Ç–∫—Ä—ã—Ç—å</button>
    {% endif %}
    </p>
    <p>üë´<strong> –ë–∏–æ–ª–æ–≥–∏—è:</strong> 
      <span 
        id="sidebar-biology"
        data-sidebar="true"
        data-user="{{ me.user.id }}"
        data-field="biology"
      >
      {{ me.biology.gender }} 
      {% if me.biology.age %}
        {{ me.biology.age }} {{ me.biology.age|age_filter }}
      {% endif %}
      {% if me.biology.orientation or me.biology.childbearing %}
        ({% if me.biology.orientation %}{{ me.biology.orientation }}{% endif %}{% if me.biology.orientation and me.biology.childbearing %}, {% endif %}{% if me.biology.childbearing %}{{ me.biology.childbearing }}{% endif %})
      {% endif %}
      {% if "biology" not in me.opened_fields %} 
        <button class="btn btn-sm btn-primary open-field" data-field="biology">–û—Ç–∫—Ä—ã—Ç—å</button>
      {% endif %}
    </p>
    <p>üé®<strong> –•–æ–±–±–∏:</strong> 
      <span 
        id="sidebar-hobby"
        data-sidebar="true"
        data-user="{{ me.user.id }}"
        data-field="hobby"
      >
      {{ me.hobby.name }}
      {% if "hobby" not in me.opened_fields %}
        <button class="btn btn-sm btn-primary open-field" data-field="hobby">–û—Ç–∫—Ä—ã—Ç—å</button>
      {% endif %}
    </p>
    <p>üò®<strong> –§–æ–±–∏—è:</strong> 
      <span 
        id="sidebar-phobias"
        data-sidebar="true"
        data-user="{{ me.user.id }}"
        data-field="phobias"
      >
      {{ me.phobias.name }}
      {% if "phobias" not in me.opened_fields %}
        <button class="btn btn-sm btn-primary open-field" data-field="phobias">–û—Ç–∫—Ä—ã—Ç—å</button>
      {% endif %}
    </p>

    <p>üë©‚Äç‚öïÔ∏è<strong> –ü—Ä–æ—Ñ–µ—Å—Å–∏—è:</strong>
      <span id="sidebar-profession" data-sidebar="true" data-user="{{ me.user.id }}" data-field="profession">
        {{ me.profession.name }}
        {% if "profession" not in me.opened_fields %}
          <button class="btn btn-sm btn-primary open-field" data-field="profession">–û—Ç–∫—Ä—ã—Ç—å</button>
        {% endif %}
      </span>
    </p>
    
    <p>üí°<strong> –§–∞–∫—Ç 1:</strong>
      <span id="sidebar-fact1" data-sidebar="true" data-user="{{ me.user.id }}" data-field="fact1">
        {{ me.fact1.name }}
        {% if "fact1" not in me.opened_fields %}
          <button class="btn btn-sm btn-primary open-field" data-field="fact1">–û—Ç–∫—Ä—ã—Ç—å</button>
        {% endif %}
      </span>
    </p>
    
    <p>üí°<strong> –§–∞–∫—Ç 2:</strong>
      <span id="sidebar-fact2" data-sidebar="true" data-user="{{ me.user.id }}" data-field="fact2">
        {{ me.fact2.name }}
        {% if "fact2" not in me.opened_fields %}
          <button class="btn btn-sm btn-primary open-field" data-field="fact2">–û—Ç–∫—Ä—ã—Ç—å</button>
        {% endif %}
      </span>
    </p>
    
    <p>üß≥<strong> –ë–∞–≥–∞–∂:</strong>
      <span id="sidebar-baggage" data-sidebar="true" data-user="{{ me.user.id }}" data-field="baggage">
        {{ me.baggage.name }}
        {% if "baggage" not in me.opened_fields %}
          <button class="btn btn-sm btn-primary open-field" data-field="baggage">–û—Ç–∫—Ä—ã—Ç—å</button>
        {% endif %}
      </span>
    </p>
    
    <p>‚ö†Ô∏è<strong> –û—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è:</strong>
      <span id="sidebar-special_condition" data-sidebar="true" data-user="{{ me.user.id }}" data-field="special_condition">
        {{ me.special_condition.name }}. –û–ø–∏—Å–∞–Ω–∏–µ: {{ me.special_condition.description }}
      </span>
    </p>
    

    <!-- <p>üë©‚Äç‚öïÔ∏è<strong>–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏:</strong>
      <span 
        id="sidebar-profession"
        data-sidebar="true"
        data-user="{{ me.user.id }}"
        data-field="profession"
      >
      {% for prof in me.profession.all %}
        {{ prof.name }}{% if not forloop.last %}, {% endif %}
      {% endfor %}
      {% if "profession" not in me.opened_fields %}
        <button class="btn btn-sm btn-primary open-field" data-field="profession">–û—Ç–∫—Ä—ã—Ç—å</button>
      {% endif %}
    </p>

    <p>üí°<strong>–§–∞–∫—Ç—ã:</strong>
      <span 
        id="sidebar-fact"
        data-sidebar="true"
        data-user="{{ me.user.id }}"
        data-field="fact"
      >
      {% for fact in me.fact.all %}
        {{ fact.name }}{% if not forloop.last %}, {% endif %}
      {% endfor %}
      {% if "fact" not in me.opened_fields %}
        <button class="btn btn-sm btn-primary open-field" data-field="fact">–û—Ç–∫—Ä—ã—Ç—å</button>
      {% endif %}
    </p>

    <p>üß≥<strong>–ë–∞–≥–∞–∂:</strong>
      <span 
        id="sidebar-baggage"
        data-sidebar="true"
        data-user="{{ me.user.id }}"
        data-field="baggage"
      >
      {% for bag in me.baggage.all %}
        {{ bag.name }}{% if not forloop.last %}, {% endif %}
      {% endfor %}
      {% if "baggage" not in me.opened_fields %}
        <button class="btn btn-sm btn-primary open-field" data-field="baggage">–û—Ç–∫—Ä—ã—Ç—å</button>
      {% endif %}
    </p>

    <p>‚ö†Ô∏è<strong>–û—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è:</strong>
      {% for sc in me.special_condition.all %}
        {{ sc.name }}. –û–ø–∏—Å–∞–Ω–∏–µ: {{ sc.description }}{% if not forloop.last %}, {% endif %}
      {% endfor %}
       {% if "special_condition" not in me.opened_fields %}
        <button class="btn btn-sm btn-primary open-field" data-field="special_condition">–û—Ç–∫—Ä—ã—Ç—å</button>
      {% endif %} 
    </p> -->
  </div>
  {% if me.is_host %}
  <div class="modal" id="swapModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" >
      <div class="modal-content">
  
        <div class="modal-header bg-dark">
          <h5 class="modal-title">–û–±–º–µ–Ω —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–æ–π</h5>
          <button type="button" class="btn-close" onclick="hideSwapModal()"></button>
        </div>
  
        <div class="modal-body bg-dark">
  
          <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É:</label>
          <select id="swapField" class="form-select">
            <option value="health">–ó–¥–æ—Ä–æ–≤—å–µ</option>
            <option value="biology">–ë–∏–æ–ª–æ–≥–∏—è</option>
            <option value="profession">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è</option>
            <option value="hobby">–•–æ–±–±–∏</option>
            <option value="phobias">–§–æ–±–∏—è</option>
            <option value="fact">–§–∞–∫—Ç</option>
            <option value="baggage">–ë–∞–≥–∞–∂</option>
          </select>
  
          <label class="mt-3">–ò–≥—Ä–æ–∫ 1:</label>
          <select id="swapUser1" class="form-select">
            {% for p in players %}
              <option value="{{ p.user.id }}">{{ p.user.username }}</option>
            {% endfor %}
          </select>
  
          <label class="mt-3">–ò–≥—Ä–æ–∫ 2:</label>
          <select id="swapUser2" class="form-select">
            {% for p in players %}
              <option value="{{ p.user.id }}">{{ p.user.username }}</option>
            {% endfor %}
          </select>
  
        </div>
  
        <div class="modal-footer bg-dark">
          <button class="btn btn-secondary" onclick="hideSwapModal()">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn btn-primary" onclick="sendSwap()">–ü–æ–º–µ–Ω—è—Ç—å</button>
        </div>
  
      </div>
    </div>
  </div>
  
  <button class="btn btn-warning mt-3 mb-2" onclick="showSwapModal()">–û–±–º–µ–Ω —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–æ–π</button>
  
  <select id="shuffleSelect" class="form-select mt-2" style="width:200px;">
    <option value="health">–ó–¥–æ—Ä–æ–≤—å–µ</option>
    <option value="biology">–ë–∏–æ–ª–æ–≥–∏—è</option>
    <option value="profession">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è</option>
    <option value="hobby">–•–æ–±–±–∏</option>
    <option value="phobias">–§–æ–±–∏—è</option>
    <option value="fact">–§–∞–∫—Ç</option>
    <option value="baggage">–ë–∞–≥–∞–∂</option>
  </select>
  <button class="btn btn-warning mt-1" onclick="shuffleField()">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É</button>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
<div class="modal" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-dark">
        <h5 class="modal-title">–£–¥–∞–ª–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É</h5>
        <button type="button" class="btn-close" onclick="hideDeleteModal()"></button>
      </div>

      <div class="modal-body bg-dark">

        <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É:</label>
        <select id="deleteField" class="form-select">
          <option value="health">–ó–¥–æ—Ä–æ–≤—å–µ</option>
          <option value="biology">–ë–∏–æ–ª–æ–≥–∏—è</option>
          <option value="profession">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è</option>
          <option value="hobby">–•–æ–±–±–∏</option>
          <option value="phobias">–§–æ–±–∏—è</option>
          <option value="fact1">–§–∞–∫—Ç 1</option>
          <option value="fact2">–§–∞–∫—Ç 2</option>
          <option value="baggage">–ë–∞–≥–∞–∂</option>
        </select>

        <label class="mt-3">–ò–≥—Ä–æ–∫:</label>
        <select id="deleteUser" class="form-select">
          {% for p in players %}
            <option value="{{ p.user.id }}">{{ p.user.username }}</option>
          {% endfor %}
        </select>

      </div>

      <div class="modal-footer bg-dark">
        <button class="btn btn-secondary" onclick="hideDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-danger" onclick="sendNew()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
        <button class="btn btn-danger" onclick="sendDelete()">–£–¥–∞–ª–∏—Ç—å</button>
      </div>

    </div>
  </div>
</div>

<button class="btn btn-warning mt-3 mb-2" onclick="showDeleteModal()">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–∞</button>


<button class="btn btn-warning mt-1" onclick="addRandomCardBtn()">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É –±—É–Ω–∫–µ—Ä–∞</button>

  {% endif %}
</div>

<div id="confirmModal" class="confirm-modal">
  <div class="confirm-content">
    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å —ç—Ç—É —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É?</p>
    <button id="confirmYes" class="btn btn-success btn-sm">–î–∞</button>
    <button id="confirmNo" class="btn btn-secondary btn-sm">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>


<script>
  const sidebar = document.getElementById('sidebar');
  const openBtn = document.getElementById('openSidebar');
  const closeBtn = document.getElementById('closeSidebar');
  const roomId = "{{ room.id }}";
  const isHost = "{{ me.is_host|yesno:'true,false' }}";
  const ws = new WebSocket(
      "ws://" + window.location.host + "/ws/room/" + roomId + "/"
  );
  let fieldToOpen = null;

  openBtn.onclick = () => {
    sidebar.classList.add('open');
  };

  closeBtn.onclick = () => {
    sidebar.classList.remove('open');
  };

  document.querySelectorAll(".open-field").forEach(btn => {
      btn.onclick = () => {
          fieldToOpen = btn;
          document.getElementById("confirmModal").style.display = "block";
      };
  });

  document.getElementById("confirmYes").onclick = () => {
      const field = fieldToOpen.dataset.field;
      ws.send(JSON.stringify({
          "type": "open_field",
          "field": field
      }));
      document.getElementById("confirmModal").style.display = "none";

      fieldToOpen.remove();
      fieldToOpen = null;
  };

  document.getElementById("confirmNo").onclick = () => {
      document.getElementById("confirmModal").style.display = "none";
      fieldToOpen = null;
  };

  document.addEventListener("DOMContentLoaded", function () {

    // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ –±—É–Ω–∫–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ —Ö–æ—Å—Ç!)
    if (isHost) {
        document.querySelectorAll('.bunker-card').forEach(card => {
            card.addEventListener('click', () => {
                const cardId = card.dataset.cardId;
                ws.send(JSON.stringify({
                    'type': 'toggle_bunker_card',
                    'card_id': cardId
                }));
            });
        });
    }
    });
  
  ws.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if (data.type === "field_opened") {
        const userId = data.user_id;
        const field = data.field;

        // –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
        const selector = `[data-user='${userId}'][data-field='${field}']`;
        const el = document.querySelector(selector);

        if (el) {
            el.innerHTML = el.dataset.realvalue; 
        }
    }
    if (data.type === "field_swapped") {
    const user1 = data.user1_id;
    const user2 = data.user2_id;
    const field = data.field;

    console.log("Swap received:", user1, user2, field);

    // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    const cards1 = document.querySelectorAll(`.card [data-user='${user1}'][data-field='${field}']`);
    const cards2 = document.querySelectorAll(`.card [data-user='${user2}'][data-field='${field}']`);

    const vals1 = Array.from(cards1).map(el => el.dataset.realvalue);
    const vals2 = Array.from(cards2).map(el => el.dataset.realvalue);

    cards1.forEach((el, i) => {
        const val2 = vals2[i] || "";
        console.log(`Card swap: user${user1} ${el.tagName} val=${el.dataset.realvalue} -> ${val2}`);
        el.innerHTML = val2;
        el.dataset.realvalue = val2;
    });

    cards2.forEach((el, i) => {
        const val1 = vals1[i] || "";
        console.log(`Card swap: user${user2} ${el.tagName} val=${el.dataset.realvalue} -> ${val1}`);
        el.innerHTML = val1;
        el.dataset.realvalue = val1;
    });

    // –°–∞–π–¥–±–∞—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const sidebar1 = document.querySelector(`#sidebar [data-user='${user1}'][data-field='${field}']`);
    const sidebar2 = document.querySelector(`#sidebar [data-user='${user2}'][data-field='${field}']`);

    if (sidebar1) {
        sidebar1.innerHTML = vals2[0] || ""; // –±–µ—Ä–µ–º –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
        sidebar1.dataset.realvalue = vals2[0] || "";
        console.log(`Sidebar updated for user1: ${sidebar1.dataset.realvalue}`);
    }

    if (sidebar2) {
        sidebar2.innerHTML = vals1[0] || "";
        sidebar2.dataset.realvalue = vals1[0] || "";
        console.log(`Sidebar updated for user2: ${sidebar2.dataset.realvalue}`);
    }
}

    if (data.type === "field_shuffled") {
      const userId = data.user_id;
      const field = data.field;
      const el = document.querySelector(`[data-user='${userId}'][data-field='${field}']`);

      if (el) {
          if (data.opened) {
              el.innerHTML = data.value;  // –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
          } else {
              el.innerHTML = "";          // –æ—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–∫—Ä—ã—Ç—ã–º
          }
          el.dataset.realvalue = data.value;  // –æ–±–Ω–æ–≤–ª—è–µ–º dataset –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –æ–±–º–µ–Ω–æ–≤
      }
    }
    if (data.type === "card_added") {
      const container = document.getElementById("bunkerCardsContainer");
      console.log(container)
      const span = document.createElement("span");
      span.textContent = data.card_name;
      span.title = data.card_description;
      span.setAttribute("data-bs-toggle", "tooltip");
      span.setAttribute("data-bs-placement", "top");
      span.style.cursor = "help";
      span.dataset.cardId = data.card_id;

      // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∫–∞—Ä—Ç—ã, –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø—è—Ç—É—é
      if (container.querySelector("span")) {
          container.appendChild(document.createTextNode(", "));
          console.log(container)
      }

      container.appendChild(span);

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç—É–ª—Ç–∏–ø –¥–ª—è –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
      new bootstrap.Tooltip(span);

      if (isHost) {
        span.addEventListener('click', () => {
        const cardId = parseInt(span.dataset.cardId);
        if (isNaN(cardId)) {
          console.error("cardId is not a number:", span.dataset.cardId);
          return;
        }
            ws.send(JSON.stringify({
                'type': 'toggle_bunker_card',
                'card_id': cardId  // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞–π id –∫–∞—Ä—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
            }));
        });
    }
    }
    
    if (data.type === "bunker_card_toggled") {
        const span = document.querySelector(`[data-card-id='${data.card_id}']`);
        if (span) {
            if (data.is_crossed) {
                span.style.textDecoration = 'line-through';
            } else {
                span.style.textDecoration = 'none';
            }
        }
    }
    if (data.type === "update_character") {
    const { user_id, field, value, opened } = data;
    console.log("WS DATA:", data);
    const isDeleted = (value === null || value === "");

    // –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞
    document.querySelectorAll(`[data-user="${user_id}"][data-field="${field}"]`)
        .forEach(el => {
            if (isDeleted) {
                el.dataset.realvalue = value || "";
                el.innerText = "";
            } else {
                el.innerText = opened ? value : "";
                console.log(opened)
            }
        });

      // –°–∞–π–¥–±–∞—Ä
      const sidebar = document.getElementById(`sidebar-${field}`);
      if (sidebar && sidebar.dataset.user == user_id) {

          sidebar.innerHTML = "";
          sidebar.dataset.realvalue = value || "";

          if (isDeleted) {
              // –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∞ ‚Äî –ø—É—Å—Ç–æ, –±–µ–∑ –∫–Ω–æ–ø–∫–∏
              sidebar.innerText = "";
              return;
          }

          if (opened) {
              // –û—Ç–∫—Ä—ã—Ç–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
              sidebar.innerText = value;
          } else {
              // –ó–∞–∫—Ä—ã—Ç–æ ‚Äî —Ç–µ–∫—Å—Ç + –∫–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å"
              sidebar.appendChild(document.createTextNode(value));

              const btn = document.createElement("button");
              btn.classList.add("btn", "btn-sm", "btn-primary", "open-field");
              btn.dataset.field = field;
              btn.innerText = "–û—Ç–∫—Ä—ã—Ç—å";

              btn.onclick = () => {
                  fieldToOpen = btn;
                  document.getElementById("confirmModal").style.display = "block";
              };

              sidebar.appendChild(btn);
          }
      }
    }
  };

  function showSwapModal() {
    document.getElementById("swapModal").style.display = "block";
  }

  function hideSwapModal() {
      document.getElementById("swapModal").style.display = "none";
  }

  function showDeleteModal() {
    document.getElementById("deleteModal").style.display = "block";
  }

  function hideDeleteModal() {
      document.getElementById("deleteModal").style.display = "none";
  }

  function addRandomCardBtn(){
    ws.send(JSON.stringify({
        "type": "add_random_card"
    }));
  }
  
  function sendSwap() {
      const field = document.getElementById("swapField").value;
      const user1 = document.getElementById("swapUser1").value;
      const user2 = document.getElementById("swapUser2").value;

      ws.send(JSON.stringify({
          "type": "swap_one",
          "user1_id": user1,
          "user2_id": user2,
          "field": field
      }));

      hideSwapModal();
  }

  function sendDelete() {
      const field = document.getElementById("deleteField").value;
      const user = document.getElementById("deleteUser").value;

      ws.send(JSON.stringify({
          type: "delete_character",
          field: field,
          user: user
      }));

      hideDeleteModal();
  }

  function sendNew() {
      const field = document.getElementById("deleteField").value;
      const user = document.getElementById("deleteUser").value;

      ws.send(JSON.stringify({
          type: "new_character",
          field: field,
          user: user
      }));

      hideDeleteModal();
  }

  function shuffleField() {
    const field = document.getElementById("shuffleSelect").value;
    ws.send(JSON.stringify({
        "type": "shuffle_field",
        "field": field
    }));
  }
</script>

{% endblock %}